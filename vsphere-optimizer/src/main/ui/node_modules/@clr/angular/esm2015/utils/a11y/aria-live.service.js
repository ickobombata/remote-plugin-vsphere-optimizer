/*
 * Copyright (c) 2016-2022 VMware, Inc. All Rights Reserved.
 * This software is released under MIT license.
 * The full license information can be found in LICENSE in the root directory of this project.
 */
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { PLATFORM_ID } from '@angular/core';
import { Inject, Injectable, NgZone } from '@angular/core';
import { uniqueIdFactory } from '../id-generator/id-generator.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export var ClrAriaLivePoliteness;
(function (ClrAriaLivePoliteness) {
    ClrAriaLivePoliteness["off"] = "off";
    ClrAriaLivePoliteness["polite"] = "polite";
    ClrAriaLivePoliteness["assertive"] = "assertive";
})(ClrAriaLivePoliteness || (ClrAriaLivePoliteness = {}));
/**
 * Time in milliseconds before inserting the content into the container
 */
const ARIA_LIVE_TICK = 100;
/**
 * @deprecated
 *
 * -- ClrAriaLiveService is deprecated in 5.0 to be removed in 6.0 --
 * Please consider using the LiveAnnouncer in the Angular Material CDK
 * if your project needs this functionality.
 * More info: https://material.angular.io/cdk/a11y/overview#example-1
 *
 * This service handle `aria-live` accessibility attribute. The issue is that you need
 * to have the DOM Element with attribute `aria-live` before you could insert content
 * and SR (Screen Reader) pick the change and announce it.
 *
 * ```typescript
 * import { ClrAriaLiveService } from 'src/clr-angular/utils/a11y/aria-live.service';
 *
 * @Component({
 * selector: 'clr-demo-component',
 * providers: [ClrAriaLiveService],
 * template: `
 *   <ng-content></ng-content>
 * `,
 * })
 * export class DemoComponent {
 *  constructor(ariaLiveService: ClrAriaLiveService) {}
 *
 *  public actionThatWillTriggerChange() {
 *    this.ariaLiveService.announce('message that I want to announce to SR');
 *  }
 * }
 * ```
 *
 */
export class ClrAriaLiveService {
    constructor(ngZone, _document, platformId) {
        this.ngZone = ngZone;
        this.platformId = platformId;
        this._id = `clr-aria-live-element-${uniqueIdFactory()}`;
        this.document = _document;
    }
    /**
     * get access to the internal HTML `id` that gonna be used for the AriaLive container.
     * @return ID of the DOM Element as string.
     */
    get id() {
        return this._id;
    }
    /**
     * Append text content inside the AriaLive Container. This method will check if the
     * DOM Element is existing if not it will create one for us and the will apply the text.
     *
     * ```typescript
     * this.ariaLiveService.announce(this.el.nativeElement);
     * // or
     * this.ariaLiveService.announce('Message to announce to SR');
     * ```
     *
     * @remark
     * When second argument is `AriaLivePoliteness.off` we won't create aria container or update it.
     * The reason for that is that we don't want to do additional work if the SR will ignore it.
     *
     * @param message - This could be simple string or HTMLElement
     * @param politeness - 'polite', 'assertive' or 'off'
     */
    announce(message, politeness = ClrAriaLivePoliteness.polite) {
        if (politeness === ClrAriaLivePoliteness.off) {
            return;
        }
        if (!this.ariaLiveElement && isPlatformBrowser(this.platformId)) {
            this.ariaLiveElement = this.createContainer();
        }
        message = typeof message !== 'string' && isPlatformBrowser(this.platformId) ? message.textContent : message;
        // when there is no message do NOTHING!
        if (!message) {
            return;
        }
        this.ariaLiveElement.setAttribute('aria-live', politeness);
        // This 100ms timeout is necessary for some browser + screen-reader combinations:
        // - Both JAWS and NVDA over IE11 will not announce anything without a non-zero timeout.
        // - With Chrome and IE11 with NVDA or JAWS, a repeated (identical) message won't be read a
        //   second time without clearing and then using a non-zero delay.
        // (using JAWS 17 at time of this writing).
        this.ngZone.runOutsideAngular(() => {
            // This clearTimeout will stop all older messages from announcing
            // in the case where the messages are comming too fast we gonna try to append only
            // the last one. That's what the SR will try to do anyway.
            clearTimeout(this.previousTimeout);
            this.previousTimeout = setTimeout(() => {
                this.ariaLiveElement.textContent = message;
            }, ARIA_LIVE_TICK);
        });
    }
    /**
     * onDestroy life cycle - must stop all active setTimeouts and remove the AriaLive
     * container from the document.
     */
    ngOnDestroy() {
        clearTimeout(this.previousTimeout);
        if (isPlatformBrowser(this.platformId) && this.ariaLiveElement) {
            this.document.body.removeChild(this.ariaLiveElement);
            this.ariaLiveElement = null;
        }
    }
    /**
     * Create AriaLive DOM element as a last child of the document.
     * After the element is created, we gonna apply Clarity class to hide it from
     * the screen and set the `aria-live` politness.
     *
     * `clr-sr-only` is the CSS class that is used to hide the element from the screen.
     *
     * @remark
     * Calling this method multiple times will create multiple DOM Elements, that
     * won't be tracked and will be GC after the service is destroyed.
     *
     * @return AriaLive container as HTMLElement
     *
     */
    createContainer() {
        const ariaLiveElement = this.document.createElement('div');
        ariaLiveElement.setAttribute('id', this.id);
        // Use clarity screen reader class to hide the dom element
        // and fix the scrollbar shake
        ariaLiveElement.classList.add('clr-sr-only');
        ariaLiveElement.setAttribute('aria-atomic', 'true');
        ariaLiveElement.setAttribute('aria-live', ClrAriaLivePoliteness.polite);
        this.document.body.appendChild(ariaLiveElement);
        return ariaLiveElement;
    }
}
ClrAriaLiveService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ClrAriaLiveService_Factory() { return new ClrAriaLiveService(i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(i1.DOCUMENT), i0.ɵɵinject(i0.PLATFORM_ID)); }, token: ClrAriaLiveService, providedIn: "root" });
ClrAriaLiveService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
ClrAriaLiveService.ctorParameters = () => [
    { type: NgZone },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJpYS1saXZlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyL3NyYy91dGlscy9hMTF5L2FyaWEtbGl2ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsUUFBUSxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFFdEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNDQUFzQyxDQUFDOzs7QUFFdkUsTUFBTSxDQUFOLElBQVkscUJBSVg7QUFKRCxXQUFZLHFCQUFxQjtJQUMvQixvQ0FBVyxDQUFBO0lBQ1gsMENBQWlCLENBQUE7SUFDakIsZ0RBQXVCLENBQUE7QUFDekIsQ0FBQyxFQUpXLHFCQUFxQixLQUFyQixxQkFBcUIsUUFJaEM7QUFFRDs7R0FFRztBQUNILE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQztBQUUzQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQStCRztBQUlILE1BQU0sT0FBTyxrQkFBa0I7SUFLN0IsWUFBb0IsTUFBYyxFQUFvQixTQUFjLEVBQStCLFVBQWU7UUFBOUYsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUFpRSxlQUFVLEdBQVYsVUFBVSxDQUFLO1FBSTFHLFFBQUcsR0FBRyx5QkFBeUIsZUFBZSxFQUFFLEVBQUUsQ0FBQztRQUh6RCxJQUFJLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQztJQUM1QixDQUFDO0lBR0Q7OztPQUdHO0lBQ0gsSUFBVyxFQUFFO1FBQ1gsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7Ozs7Ozs7Ozs7Ozs7OztPQWdCRztJQUNJLFFBQVEsQ0FDYixPQUE2QixFQUM3QixhQUFvQyxxQkFBcUIsQ0FBQyxNQUFNO1FBRWhFLElBQUksVUFBVSxLQUFLLHFCQUFxQixDQUFDLEdBQUcsRUFBRTtZQUM1QyxPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDL0QsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7U0FDL0M7UUFFRCxPQUFPLEdBQUcsT0FBTyxPQUFPLEtBQUssUUFBUSxJQUFJLGlCQUFpQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBRTVHLHVDQUF1QztRQUN2QyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1osT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRTNELGlGQUFpRjtRQUNqRix3RkFBd0Y7UUFDeEYsMkZBQTJGO1FBQzNGLGtFQUFrRTtRQUNsRSwyQ0FBMkM7UUFDM0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUU7WUFDakMsaUVBQWlFO1lBQ2pFLGtGQUFrRjtZQUNsRiwwREFBMEQ7WUFDMUQsWUFBWSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNuQyxJQUFJLENBQUMsZUFBZSxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3JDLElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxHQUFHLE9BQWlCLENBQUM7WUFDdkQsQ0FBQyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ3JCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7T0FHRztJQUNJLFdBQVc7UUFDaEIsWUFBWSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNuQyxJQUFJLGlCQUFpQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQzlELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7U0FDN0I7SUFDSCxDQUFDO0lBRUQ7Ozs7Ozs7Ozs7Ozs7T0FhRztJQUNLLGVBQWU7UUFDckIsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFM0QsZUFBZSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLDBEQUEwRDtRQUMxRCw4QkFBOEI7UUFDOUIsZUFBZSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFN0MsZUFBZSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDcEQsZUFBZSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFeEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRWhELE9BQU8sZUFBZSxDQUFDO0lBQ3pCLENBQUM7Ozs7WUFuSEYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7WUFqRDRCLE1BQU07NENBdURJLE1BQU0sU0FBQyxRQUFROzRDQUFtQixNQUFNLFNBQUMsV0FBVyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTYtMjAyMiBWTXdhcmUsIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIFRoaXMgc29mdHdhcmUgaXMgcmVsZWFzZWQgdW5kZXIgTUlUIGxpY2Vuc2UuXG4gKiBUaGUgZnVsbCBsaWNlbnNlIGluZm9ybWF0aW9uIGNhbiBiZSBmb3VuZCBpbiBMSUNFTlNFIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHByb2plY3QuXG4gKi9cblxuaW1wb3J0IHsgRE9DVU1FTlQsIGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IFBMQVRGT1JNX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE5nWm9uZSwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IHVuaXF1ZUlkRmFjdG9yeSB9IGZyb20gJy4uL2lkLWdlbmVyYXRvci9pZC1nZW5lcmF0b3Iuc2VydmljZSc7XG5cbmV4cG9ydCBlbnVtIENsckFyaWFMaXZlUG9saXRlbmVzcyB7XG4gIG9mZiA9ICdvZmYnLFxuICBwb2xpdGUgPSAncG9saXRlJyxcbiAgYXNzZXJ0aXZlID0gJ2Fzc2VydGl2ZScsXG59XG5cbi8qKlxuICogVGltZSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGluc2VydGluZyB0aGUgY29udGVudCBpbnRvIHRoZSBjb250YWluZXJcbiAqL1xuY29uc3QgQVJJQV9MSVZFX1RJQ0sgPSAxMDA7XG5cbi8qKlxuICogQGRlcHJlY2F0ZWRcbiAqXG4gKiAtLSBDbHJBcmlhTGl2ZVNlcnZpY2UgaXMgZGVwcmVjYXRlZCBpbiA1LjAgdG8gYmUgcmVtb3ZlZCBpbiA2LjAgLS1cbiAqIFBsZWFzZSBjb25zaWRlciB1c2luZyB0aGUgTGl2ZUFubm91bmNlciBpbiB0aGUgQW5ndWxhciBNYXRlcmlhbCBDREtcbiAqIGlmIHlvdXIgcHJvamVjdCBuZWVkcyB0aGlzIGZ1bmN0aW9uYWxpdHkuXG4gKiBNb3JlIGluZm86IGh0dHBzOi8vbWF0ZXJpYWwuYW5ndWxhci5pby9jZGsvYTExeS9vdmVydmlldyNleGFtcGxlLTFcbiAqXG4gKiBUaGlzIHNlcnZpY2UgaGFuZGxlIGBhcmlhLWxpdmVgIGFjY2Vzc2liaWxpdHkgYXR0cmlidXRlLiBUaGUgaXNzdWUgaXMgdGhhdCB5b3UgbmVlZFxuICogdG8gaGF2ZSB0aGUgRE9NIEVsZW1lbnQgd2l0aCBhdHRyaWJ1dGUgYGFyaWEtbGl2ZWAgYmVmb3JlIHlvdSBjb3VsZCBpbnNlcnQgY29udGVudFxuICogYW5kIFNSIChTY3JlZW4gUmVhZGVyKSBwaWNrIHRoZSBjaGFuZ2UgYW5kIGFubm91bmNlIGl0LlxuICpcbiAqIGBgYHR5cGVzY3JpcHRcbiAqIGltcG9ydCB7IENsckFyaWFMaXZlU2VydmljZSB9IGZyb20gJ3NyYy9jbHItYW5ndWxhci91dGlscy9hMTF5L2FyaWEtbGl2ZS5zZXJ2aWNlJztcbiAqXG4gKiBAQ29tcG9uZW50KHtcbiAqIHNlbGVjdG9yOiAnY2xyLWRlbW8tY29tcG9uZW50JyxcbiAqIHByb3ZpZGVyczogW0NsckFyaWFMaXZlU2VydmljZV0sXG4gKiB0ZW1wbGF0ZTogYFxuICogICA8bmctY29udGVudD48L25nLWNvbnRlbnQ+XG4gKiBgLFxuICogfSlcbiAqIGV4cG9ydCBjbGFzcyBEZW1vQ29tcG9uZW50IHtcbiAqICBjb25zdHJ1Y3RvcihhcmlhTGl2ZVNlcnZpY2U6IENsckFyaWFMaXZlU2VydmljZSkge31cbiAqXG4gKiAgcHVibGljIGFjdGlvblRoYXRXaWxsVHJpZ2dlckNoYW5nZSgpIHtcbiAqICAgIHRoaXMuYXJpYUxpdmVTZXJ2aWNlLmFubm91bmNlKCdtZXNzYWdlIHRoYXQgSSB3YW50IHRvIGFubm91bmNlIHRvIFNSJyk7XG4gKiAgfVxuICogfVxuICogYGBgXG4gKlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgQ2xyQXJpYUxpdmVTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBhcmlhTGl2ZUVsZW1lbnQ6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIGRvY3VtZW50OiBEb2N1bWVudDtcbiAgcHJpdmF0ZSBwcmV2aW91c1RpbWVvdXQ6IFJldHVyblR5cGU8dHlwZW9mIHNldFRpbWVvdXQ+O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdab25lOiBOZ1pvbmUsIEBJbmplY3QoRE9DVU1FTlQpIF9kb2N1bWVudDogYW55LCBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IGFueSkge1xuICAgIHRoaXMuZG9jdW1lbnQgPSBfZG9jdW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIF9pZCA9IGBjbHItYXJpYS1saXZlLWVsZW1lbnQtJHt1bmlxdWVJZEZhY3RvcnkoKX1gO1xuICAvKipcbiAgICogZ2V0IGFjY2VzcyB0byB0aGUgaW50ZXJuYWwgSFRNTCBgaWRgIHRoYXQgZ29ubmEgYmUgdXNlZCBmb3IgdGhlIEFyaWFMaXZlIGNvbnRhaW5lci5cbiAgICogQHJldHVybiBJRCBvZiB0aGUgRE9NIEVsZW1lbnQgYXMgc3RyaW5nLlxuICAgKi9cbiAgcHVibGljIGdldCBpZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9pZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBlbmQgdGV4dCBjb250ZW50IGluc2lkZSB0aGUgQXJpYUxpdmUgQ29udGFpbmVyLiBUaGlzIG1ldGhvZCB3aWxsIGNoZWNrIGlmIHRoZVxuICAgKiBET00gRWxlbWVudCBpcyBleGlzdGluZyBpZiBub3QgaXQgd2lsbCBjcmVhdGUgb25lIGZvciB1cyBhbmQgdGhlIHdpbGwgYXBwbHkgdGhlIHRleHQuXG4gICAqXG4gICAqIGBgYHR5cGVzY3JpcHRcbiAgICogdGhpcy5hcmlhTGl2ZVNlcnZpY2UuYW5ub3VuY2UodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcbiAgICogLy8gb3JcbiAgICogdGhpcy5hcmlhTGl2ZVNlcnZpY2UuYW5ub3VuY2UoJ01lc3NhZ2UgdG8gYW5ub3VuY2UgdG8gU1InKTtcbiAgICogYGBgXG4gICAqXG4gICAqIEByZW1hcmtcbiAgICogV2hlbiBzZWNvbmQgYXJndW1lbnQgaXMgYEFyaWFMaXZlUG9saXRlbmVzcy5vZmZgIHdlIHdvbid0IGNyZWF0ZSBhcmlhIGNvbnRhaW5lciBvciB1cGRhdGUgaXQuXG4gICAqIFRoZSByZWFzb24gZm9yIHRoYXQgaXMgdGhhdCB3ZSBkb24ndCB3YW50IHRvIGRvIGFkZGl0aW9uYWwgd29yayBpZiB0aGUgU1Igd2lsbCBpZ25vcmUgaXQuXG4gICAqXG4gICAqIEBwYXJhbSBtZXNzYWdlIC0gVGhpcyBjb3VsZCBiZSBzaW1wbGUgc3RyaW5nIG9yIEhUTUxFbGVtZW50XG4gICAqIEBwYXJhbSBwb2xpdGVuZXNzIC0gJ3BvbGl0ZScsICdhc3NlcnRpdmUnIG9yICdvZmYnXG4gICAqL1xuICBwdWJsaWMgYW5ub3VuY2UoXG4gICAgbWVzc2FnZTogc3RyaW5nIHwgSFRNTEVsZW1lbnQsXG4gICAgcG9saXRlbmVzczogQ2xyQXJpYUxpdmVQb2xpdGVuZXNzID0gQ2xyQXJpYUxpdmVQb2xpdGVuZXNzLnBvbGl0ZVxuICApOiB2b2lkIHtcbiAgICBpZiAocG9saXRlbmVzcyA9PT0gQ2xyQXJpYUxpdmVQb2xpdGVuZXNzLm9mZikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5hcmlhTGl2ZUVsZW1lbnQgJiYgaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQgPSB0aGlzLmNyZWF0ZUNvbnRhaW5lcigpO1xuICAgIH1cblxuICAgIG1lc3NhZ2UgPSB0eXBlb2YgbWVzc2FnZSAhPT0gJ3N0cmluZycgJiYgaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSA/IG1lc3NhZ2UudGV4dENvbnRlbnQgOiBtZXNzYWdlO1xuXG4gICAgLy8gd2hlbiB0aGVyZSBpcyBubyBtZXNzYWdlIGRvIE5PVEhJTkchXG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWxpdmUnLCBwb2xpdGVuZXNzKTtcblxuICAgIC8vIFRoaXMgMTAwbXMgdGltZW91dCBpcyBuZWNlc3NhcnkgZm9yIHNvbWUgYnJvd3NlciArIHNjcmVlbi1yZWFkZXIgY29tYmluYXRpb25zOlxuICAgIC8vIC0gQm90aCBKQVdTIGFuZCBOVkRBIG92ZXIgSUUxMSB3aWxsIG5vdCBhbm5vdW5jZSBhbnl0aGluZyB3aXRob3V0IGEgbm9uLXplcm8gdGltZW91dC5cbiAgICAvLyAtIFdpdGggQ2hyb21lIGFuZCBJRTExIHdpdGggTlZEQSBvciBKQVdTLCBhIHJlcGVhdGVkIChpZGVudGljYWwpIG1lc3NhZ2Ugd29uJ3QgYmUgcmVhZCBhXG4gICAgLy8gICBzZWNvbmQgdGltZSB3aXRob3V0IGNsZWFyaW5nIGFuZCB0aGVuIHVzaW5nIGEgbm9uLXplcm8gZGVsYXkuXG4gICAgLy8gKHVzaW5nIEpBV1MgMTcgYXQgdGltZSBvZiB0aGlzIHdyaXRpbmcpLlxuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIC8vIFRoaXMgY2xlYXJUaW1lb3V0IHdpbGwgc3RvcCBhbGwgb2xkZXIgbWVzc2FnZXMgZnJvbSBhbm5vdW5jaW5nXG4gICAgICAvLyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgbWVzc2FnZXMgYXJlIGNvbW1pbmcgdG9vIGZhc3Qgd2UgZ29ubmEgdHJ5IHRvIGFwcGVuZCBvbmx5XG4gICAgICAvLyB0aGUgbGFzdCBvbmUuIFRoYXQncyB3aGF0IHRoZSBTUiB3aWxsIHRyeSB0byBkbyBhbnl3YXkuXG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5wcmV2aW91c1RpbWVvdXQpO1xuICAgICAgdGhpcy5wcmV2aW91c1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQudGV4dENvbnRlbnQgPSBtZXNzYWdlIGFzIHN0cmluZztcbiAgICAgIH0sIEFSSUFfTElWRV9USUNLKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBvbkRlc3Ryb3kgbGlmZSBjeWNsZSAtIG11c3Qgc3RvcCBhbGwgYWN0aXZlIHNldFRpbWVvdXRzIGFuZCByZW1vdmUgdGhlIEFyaWFMaXZlXG4gICAqIGNvbnRhaW5lciBmcm9tIHRoZSBkb2N1bWVudC5cbiAgICovXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpIHtcbiAgICBjbGVhclRpbWVvdXQodGhpcy5wcmV2aW91c1RpbWVvdXQpO1xuICAgIGlmIChpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpICYmIHRoaXMuYXJpYUxpdmVFbGVtZW50KSB7XG4gICAgICB0aGlzLmRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5hcmlhTGl2ZUVsZW1lbnQpO1xuICAgICAgdGhpcy5hcmlhTGl2ZUVsZW1lbnQgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgQXJpYUxpdmUgRE9NIGVsZW1lbnQgYXMgYSBsYXN0IGNoaWxkIG9mIHRoZSBkb2N1bWVudC5cbiAgICogQWZ0ZXIgdGhlIGVsZW1lbnQgaXMgY3JlYXRlZCwgd2UgZ29ubmEgYXBwbHkgQ2xhcml0eSBjbGFzcyB0byBoaWRlIGl0IGZyb21cbiAgICogdGhlIHNjcmVlbiBhbmQgc2V0IHRoZSBgYXJpYS1saXZlYCBwb2xpdG5lc3MuXG4gICAqXG4gICAqIGBjbHItc3Itb25seWAgaXMgdGhlIENTUyBjbGFzcyB0aGF0IGlzIHVzZWQgdG8gaGlkZSB0aGUgZWxlbWVudCBmcm9tIHRoZSBzY3JlZW4uXG4gICAqXG4gICAqIEByZW1hcmtcbiAgICogQ2FsbGluZyB0aGlzIG1ldGhvZCBtdWx0aXBsZSB0aW1lcyB3aWxsIGNyZWF0ZSBtdWx0aXBsZSBET00gRWxlbWVudHMsIHRoYXRcbiAgICogd29uJ3QgYmUgdHJhY2tlZCBhbmQgd2lsbCBiZSBHQyBhZnRlciB0aGUgc2VydmljZSBpcyBkZXN0cm95ZWQuXG4gICAqXG4gICAqIEByZXR1cm4gQXJpYUxpdmUgY29udGFpbmVyIGFzIEhUTUxFbGVtZW50XG4gICAqXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZUNvbnRhaW5lcigpOiBIVE1MRWxlbWVudCB7XG4gICAgY29uc3QgYXJpYUxpdmVFbGVtZW50ID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblxuICAgIGFyaWFMaXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2lkJywgdGhpcy5pZCk7XG4gICAgLy8gVXNlIGNsYXJpdHkgc2NyZWVuIHJlYWRlciBjbGFzcyB0byBoaWRlIHRoZSBkb20gZWxlbWVudFxuICAgIC8vIGFuZCBmaXggdGhlIHNjcm9sbGJhciBzaGFrZVxuICAgIGFyaWFMaXZlRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdjbHItc3Itb25seScpO1xuXG4gICAgYXJpYUxpdmVFbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1hdG9taWMnLCAndHJ1ZScpO1xuICAgIGFyaWFMaXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGl2ZScsIENsckFyaWFMaXZlUG9saXRlbmVzcy5wb2xpdGUpO1xuXG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGFyaWFMaXZlRWxlbWVudCk7XG5cbiAgICByZXR1cm4gYXJpYUxpdmVFbGVtZW50O1xuICB9XG59XG4iXX0=