{"version":3,"file":"focus-trap.js","sources":["../../../../src/internal/utils/focus-trap.ts"],"sourcesContent":["/*\n * Copyright (c) 2016-2022 VMware, Inc. All Rights Reserved.\n * This software is released under MIT license.\n * The full license information can be found in LICENSE in the root directory of this project.\n */\nimport { FocusTrapTrackerService } from '../services/focus-trap-tracker.service.js';\nimport { isHTMLElement, isFocusable } from './dom.js';\nimport { createId } from './identity.js';\nexport function refocusIfOutsideFocusTrapElement(focusedElement, focusTrapElement, elementToRefocus) {\n    const focusTrapIsCurrent = FocusTrapTrackerService.getCurrent() === focusTrapElement;\n    const elementToFocusIsOutsideFocusTrap = elementIsOutsideFocusTrapElement(focusedElement, focusTrapElement);\n    if (focusTrapIsCurrent && elementToFocusIsOutsideFocusTrap) {\n        elementToRefocus = elementToRefocus || focusTrapElement;\n        elementToRefocus.focus();\n    }\n    else {\n        focusedElement.focus();\n    }\n}\nexport function elementIsOutsideFocusTrapElement(focusedElement, focusTrapElement) {\n    if (focusedElement === focusTrapElement.topReboundElement ||\n        focusedElement === focusTrapElement.bottomReboundElement) {\n        return true;\n    }\n    const elementIsInFocusTrapLightDom = focusTrapElement.contains(focusedElement);\n    if (elementIsInFocusTrapLightDom) {\n        return false;\n    }\n    if (focusTrapElement.shadowRoot !== null && focusTrapElement.shadowRoot.contains(focusedElement)) {\n        return false;\n    }\n    return true;\n}\nexport function createFocusTrapReboundElement() {\n    const offScreenSpan = document.createElement('span');\n    offScreenSpan.setAttribute('tabindex', '0');\n    offScreenSpan.classList.add('offscreen-focus-rebounder');\n    return offScreenSpan;\n}\nexport function addReboundElementsToFocusTrapElement(focusTrapElement) {\n    if (focusTrapElement && !focusTrapElement.topReboundElement && !focusTrapElement.bottomReboundElement) {\n        focusTrapElement.topReboundElement = createFocusTrapReboundElement();\n        focusTrapElement.bottomReboundElement = createFocusTrapReboundElement();\n        const parent = focusTrapElement.parentElement;\n        const sibling = focusTrapElement.nextSibling;\n        if (parent) {\n            parent.insertBefore(focusTrapElement.topReboundElement, focusTrapElement);\n            if (sibling) {\n                parent.insertBefore(focusTrapElement.bottomReboundElement, sibling);\n            }\n            else {\n                parent.appendChild(focusTrapElement.bottomReboundElement);\n            }\n        }\n    }\n}\nexport function removeReboundElementsFromFocusTrapElement(focusTrapElement) {\n    if (focusTrapElement) {\n        const parent = focusTrapElement.parentElement;\n        if (parent) {\n            const topRebound = focusTrapElement.topReboundElement;\n            const bottomRebound = focusTrapElement.bottomReboundElement;\n            if (topRebound) {\n                parent.removeChild(topRebound);\n            }\n            if (bottomRebound) {\n                parent.removeChild(bottomRebound);\n            }\n        }\n        // These are here to to make sure that we completely delete all traces of the removed DOM objects.\n        delete focusTrapElement.topReboundElement;\n        delete focusTrapElement.bottomReboundElement;\n    }\n}\n// this helper exists to enable the focus trap class to handle vanilla html elements\n// it's primary concern is to keep TS happy.\n// end users should prefer using the CdsBaseFocusTrap component to this method.\n// but it exists...\nexport function castHtmlElementToFocusTrapElement(el) {\n    return el;\n}\nexport class FocusTrap {\n    constructor(hostElement) {\n        this.active = false;\n        hostElement = castHtmlElementToFocusTrapElement(hostElement);\n        if (!hostElement.focusTrapId) {\n            hostElement.focusTrapId = createId();\n        }\n        this.focusTrapElement = hostElement;\n    }\n    enableFocusTrap() {\n        const fte = this.focusTrapElement;\n        const firstFocusElement = fte.querySelector('[cds-first-focus]');\n        const contentWrapper = fte.shadowRoot ? fte.shadowRoot.querySelector('.private-host[tabindex]') : null;\n        const activeEl = document.activeElement;\n        if (FocusTrapTrackerService.getCurrent() === fte) {\n            throw new Error('Focus trap is already enabled for this instance.');\n        }\n        this.firstFocusElement =\n            firstFocusElement || contentWrapper || this.focusTrapElement;\n        addReboundElementsToFocusTrapElement(fte);\n        if (!isFocusable(fte)) {\n            fte.setAttribute('tabindex', '-1');\n        }\n        if (activeEl && isHTMLElement(activeEl)) {\n            this.previousFocus = activeEl;\n        }\n        FocusTrapTrackerService.setCurrent(fte);\n        // setTimeout here is required for Safari which may try to set focus on\n        // element before it is visible...\n        const focusTimer = setTimeout(() => {\n            this.firstFocusElement.focus();\n            clearTimeout(focusTimer);\n        }, 10);\n        this.onFocusInEvent = this.onFocusIn.bind(this);\n        document.addEventListener('focusin', this.onFocusInEvent);\n        this.active = true;\n    }\n    removeFocusTrap() {\n        document.removeEventListener('focusin', this.onFocusInEvent);\n        removeReboundElementsFromFocusTrapElement(this.focusTrapElement);\n        FocusTrapTrackerService.activatePreviousCurrent();\n        this.active = false;\n        if (this.previousFocus) {\n            this.previousFocus.focus();\n        }\n    }\n    onFocusIn(event) {\n        refocusIfOutsideFocusTrapElement(event.composedPath()[0], this.focusTrapElement, this.firstFocusElement);\n    }\n}\n"],"names":["refocusIfOutsideFocusTrapElement","focusedElement","focusTrapElement","elementToRefocus","focusTrapIsCurrent","FocusTrapTrackerService","getCurrent","elementToFocusIsOutsideFocusTrap","elementIsOutsideFocusTrapElement","focus","topReboundElement","bottomReboundElement","contains","shadowRoot","createFocusTrapReboundElement","offScreenSpan","document","createElement","setAttribute","classList","add","addReboundElementsToFocusTrapElement","parent","parentElement","sibling","nextSibling","insertBefore","appendChild","removeReboundElementsFromFocusTrapElement","topRebound","bottomRebound","removeChild","castHtmlElementToFocusTrapElement","el","FocusTrap","constructor","hostElement","this","active","focusTrapId","createId","enableFocusTrap","fte","firstFocusElement","querySelector","contentWrapper","activeEl","activeElement","Error","isFocusable","isHTMLElement","previousFocus","setCurrent","focusTimer","setTimeout","clearTimeout","onFocusInEvent","onFocusIn","bind","addEventListener","removeFocusTrap","removeEventListener","activatePreviousCurrent","event","composedPath"],"mappings":"uLAQO,SAASA,EAAiCC,EAAgBC,EAAkBC,GAC/E,MAAMC,EAAqBC,EAAwBC,eAAiBJ,EAC9DK,EAAmCC,EAAiCP,EAAgBC,GACtFE,GAAsBG,GACtBJ,EAAmBA,GAAoBD,GACtBO,QAGjBR,EAAeQ,QAGhB,SAASD,EAAiCP,EAAgBC,GAC7D,OAAID,IAAmBC,EAAiBQ,mBACpCT,IAAmBC,EAAiBS,wBAGHT,EAAiBU,SAASX,IAI3B,OAAhCC,EAAiBW,YAAuBX,EAAiBW,WAAWD,SAASX,IAK9E,SAASa,IACZ,MAAMC,EAAgBC,SAASC,cAAc,QAG7C,OAFAF,EAAcG,aAAa,WAAY,KACvCH,EAAcI,UAAUC,IAAI,6BACrBL,EAEJ,SAASM,EAAqCnB,GACjD,GAAIA,IAAqBA,EAAiBQ,oBAAsBR,EAAiBS,qBAAsB,CACnGT,EAAiBQ,kBAAoBI,IACrCZ,EAAiBS,qBAAuBG,IACxC,MAAMQ,EAASpB,EAAiBqB,cAC1BC,EAAUtB,EAAiBuB,YAC7BH,IACAA,EAAOI,aAAaxB,EAAiBQ,kBAAmBR,GACpDsB,EACAF,EAAOI,aAAaxB,EAAiBS,qBAAsBa,GAG3DF,EAAOK,YAAYzB,EAAiBS,wBAK7C,SAASiB,EAA0C1B,GACtD,GAAIA,EAAkB,CAClB,MAAMoB,EAASpB,EAAiBqB,cAChC,GAAID,EAAQ,CACR,MAAMO,EAAa3B,EAAiBQ,kBAC9BoB,EAAgB5B,EAAiBS,qBACnCkB,GACAP,EAAOS,YAAYF,GAEnBC,GACAR,EAAOS,YAAYD,UAIpB5B,EAAiBQ,yBACjBR,EAAiBS,sBAOzB,SAASqB,EAAkCC,GAC9C,OAAOA,EAEJ,MAAMC,EACTC,YAAYC,GACRC,KAAKC,QAAS,GACdF,EAAgDA,GAC/BG,cACbH,EAAYG,YAAcC,KAE9BH,KAAKnC,iBAAmBkC,EAE5BK,kBACI,MAAMC,EAAML,KAAKnC,iBACXyC,EAAoBD,EAAIE,cAAc,qBACtCC,EAAiBH,EAAI7B,WAAa6B,EAAI7B,WAAW+B,cAAc,2BAA6B,KAC5FE,EAAW9B,SAAS+B,cAC1B,GAAI1C,EAAwBC,eAAiBoC,EACzC,MAAUM,MAAM,oDAEpBX,KAAKM,kBACDA,GAAqBE,GAAkBR,KAAKnC,iBAChDmB,EAAqCqB,GAChCO,EAAYP,IACbA,EAAIxB,aAAa,WAAY,MAE7B4B,GAAYI,EAAcJ,KAC1BT,KAAKc,cAAgBL,GAEzBzC,EAAwB+C,WAAWV,GAGnC,MAAMW,EAAaC,YAAW,KAC1BjB,KAAKM,kBAAkBlC,QACvB8C,aAAaF,KACd,IACHhB,KAAKmB,eAAiBnB,KAAKoB,UAAUC,KAAKrB,MAC1CrB,SAAS2C,iBAAiB,UAAWtB,KAAKmB,gBAC1CnB,KAAKC,QAAS,EAElBsB,kBACI5C,SAAS6C,oBAAoB,UAAWxB,KAAKmB,gBAC7C5B,EAA0CS,KAAKnC,kBAC/CG,EAAwByD,0BACxBzB,KAAKC,QAAS,EACVD,KAAKc,eACLd,KAAKc,cAAc1C,QAG3BgD,UAAUM,GACN/D,EAAiC+D,EAAMC,eAAe,GAAI3B,KAAKnC,iBAAkBmC,KAAKM"}