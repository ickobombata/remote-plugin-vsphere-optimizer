{"version":3,"file":"overlay.element.js","sources":["../../../../src/internal-components/overlay/overlay.element.ts"],"sourcesContent":["/*\n * Copyright (c) 2016-2022 VMware, Inc. All Rights Reserved.\n * This software is released under MIT license.\n * The full license information can be found in LICENSE in the root directory of this project.\n */\nimport { __decorate } from \"tslib\";\nimport { animate, baseStyles, createId, CdsBaseFocusTrap, event, FocusTrapTrackerService, state, onKey, property, AnimationModalEnterName, reverseAnimation, } from '@cds/core/internal';\nimport { html } from 'lit';\nimport { query } from 'lit/decorators/query.js';\nimport styles from './overlay.element.scss';\nexport function isNestedOverlay(myId, overlayPrefix, trapIds, previousValue) {\n    const overlayIds = trapIds.filter(id => id.indexOf(overlayPrefix) > -1);\n    if (previousValue === true && trapIds.indexOf(myId) < 0) {\n        // handling situation where focusTrapIds remove our overlay from the list and we still need to consider\n        // this overlay as nested. this happens when an overlay is being closed/hidden\n        return true;\n    }\n    return overlayIds.indexOf(myId) > 0; // id is present and not the first one...\n}\nexport function overlayIsActive(overlayId, focusTrapService = FocusTrapTrackerService) {\n    var _a;\n    return ((_a = focusTrapService.getCurrent()) === null || _a === void 0 ? void 0 : _a.focusTrapId) === overlayId;\n}\n/**\n *\n * ```typescript\n * import '@cds/core/internal-components/overlay/register.js';\n * ```\n *\n * ```html\n * <cds-internal-overlay>\n *  <section cds-layout=\"vertical align:horizontal-stretch\">\n *    <div cds-layout=\"vertical pad:md gap:md\">\n *      <h2 cds-text=\"display\">A Title</h2>\n *      <div>\n *        <p cds-text=\"body\">\n *          Content inside a generic overlay.\n *        </p>\n *      </div>\n *    </div>\n *  </section>\n * </cds-internal-overlay>\n * ```\n *\n * @beta\n * @element cds-internal-overlay\n * @slot - Content slot for the content inside the overlay's panel\n * @event closeChange - Notify user when close event has occurred\n * @cssprop --backdrop-background\n * @cssprop --layered-backdrop-background\n * @cssprop --animation-duration\n * @cssprop --animation-easing\n *\n * KNOWN ISSUE: Safari jumps through the exit animation but only when the ESC key is pressed.\n *\n */\nlet CdsInternalOverlay = class CdsInternalOverlay extends CdsBaseFocusTrap {\n    constructor() {\n        super();\n        this.cdsMotion = 'on';\n        this.overlayIdPrefix = '_overlay-';\n        this.isLayered = false;\n        this.fireEventOnBackdropClick = () => {\n            if (overlayIsActive(this.focusTrapId)) {\n                this.closeOverlay('backdrop-click');\n            }\n        };\n        this.fireEventOnEscape = (e) => {\n            if (overlayIsActive(this.focusTrapId)) {\n                onKey('escape', e, () => {\n                    this.closeOverlay('escape-keypress');\n                });\n            }\n        };\n        // override focus-trap base id so we know this is an overlay\n        this.focusTrapId = createId(this.overlayIdPrefix);\n    }\n    // renderRoot needs delegatesFocus so that focus can cross the shadowDOM\n    // inside an element with aria-modal set to true\n    /** @private */\n    static get shadowRootOptions() {\n        // any is used until TS 4.4.x adopted through other @cds/* libraries. Can be removed in 6.0\n        return { ...super.shadowRootOptions, delegatesFocus: true };\n    }\n    firstUpdated(props) {\n        super.firstUpdated(props);\n        this.backdrop.addEventListener('click', this.fireEventOnBackdropClick);\n    }\n    updated(props) {\n        super.updated(props);\n        const oldLayered = this.isLayered;\n        const newLayered = isNestedOverlay(this.focusTrapId, this.overlayIdPrefix, FocusTrapTrackerService.getTrapElements().map(e => e.focusTrapId), oldLayered);\n        if (oldLayered !== newLayered) {\n            this.isLayered = newLayered;\n            this.requestUpdate('isLayered', oldLayered);\n        }\n    }\n    connectedCallback() {\n        super.connectedCallback();\n        this.ariaModal = 'true';\n        this.role = 'dialog';\n        window.addEventListener('keydown', this.fireEventOnEscape);\n    }\n    disconnectedCallback() {\n        super.disconnectedCallback();\n        window.removeEventListener('keydown', this.fireEventOnEscape);\n        this.backdrop.removeEventListener('click', this.fireEventOnBackdropClick);\n    }\n    closeOverlay(trigger = 'custom') {\n        this.closeChange.emit(trigger);\n    }\n    get backdropTemplate() {\n        return html `<div\n      class=\"${this.isLayered ? 'overlay-backdrop layered' : 'overlay-backdrop'}\"\n      aria-hidden=\"true\"\n    ></div>`;\n    }\n    render() {\n        return html `\n      ${this.backdropTemplate}\n      <div class=\"private-host\" tabindex=\"-1\" aria-modal=\"true\" role=\"dialog\">\n        <slot></slot>\n      </div>\n    `;\n    }\n    static get styles() {\n        return [baseStyles, styles];\n    }\n};\n__decorate([\n    property({ type: String })\n], CdsInternalOverlay.prototype, \"cdsMotion\", void 0);\n__decorate([\n    event()\n], CdsInternalOverlay.prototype, \"cdsMotionChange\", void 0);\n__decorate([\n    event()\n], CdsInternalOverlay.prototype, \"closeChange\", void 0);\n__decorate([\n    state({ type: Boolean })\n], CdsInternalOverlay.prototype, \"isLayered\", void 0);\n__decorate([\n    query('.overlay-backdrop')\n], CdsInternalOverlay.prototype, \"backdrop\", void 0);\nCdsInternalOverlay = __decorate([\n    animate({\n        hidden: {\n            true: reverseAnimation(AnimationModalEnterName),\n            false: AnimationModalEnterName,\n        },\n    })\n], CdsInternalOverlay);\nexport { CdsInternalOverlay };\n"],"names":["isNestedOverlay","myId","overlayPrefix","trapIds","previousValue","overlayIds","filter","id","indexOf","overlayIsActive","overlayId","focusTrapService","FocusTrapTrackerService","_a","getCurrent","focusTrapId","CdsInternalOverlay","CdsBaseFocusTrap","constructor","super","this","cdsMotion","overlayIdPrefix","isLayered","fireEventOnBackdropClick","closeOverlay","fireEventOnEscape","e","onKey","createId","shadowRootOptions","delegatesFocus","firstUpdated","props","backdrop","addEventListener","updated","oldLayered","newLayered","getTrapElements","map","requestUpdate","connectedCallback","ariaModal","role","window","disconnectedCallback","removeEventListener","trigger","closeChange","emit","backdropTemplate","html","render","styles","baseStyles","__decorate","property","type","String","prototype","event","state","Boolean","query","animate","hidden","true","reverseAnimation","AnimationModalEnterName","false"],"mappings":"uXAUO,SAASA,EAAgBC,EAAMC,EAAeC,EAASC,GAC1D,MAAMC,EAAaF,EAAQG,QAAOC,GAAMA,EAAGC,QAAQN,IAAkB,IACrE,OAAsB,IAAlBE,GAA0BD,EAAQK,QAAQP,GAAQ,GAK/CI,EAAWG,QAAQP,GAAQ,EAE/B,SAASQ,EAAgBC,EAAWC,EAAmBC,GAC1D,IAAIC,EACJ,OAAiD,QAAxCA,EAAKF,EAAiBG,oBAAiC,IAAPD,OAAgB,EAASA,EAAGE,eAAiBL,EAmCvG,IAACM,EAAqB,cAAiCC,EACtDC,cACIC,QACAC,KAAKC,UAAY,KACjBD,KAAKE,gBAAkB,YACvBF,KAAKG,WAAY,EACjBH,KAAKI,yBAA2B,KACxBf,EAAgBW,KAAKL,cACrBK,KAAKK,aAAa,mBAG1BL,KAAKM,kBAAqBC,IAClBlB,EAAgBW,KAAKL,cACrBa,EAAM,SAAUD,GAAG,KACfP,KAAKK,aAAa,uBAK9BL,KAAKL,YAAcc,EAAST,KAAKE,iBAK1BQ,+BAEP,MAAO,IAAKX,MAAMW,kBAAmBC,gBAAgB,GAEzDC,aAAaC,GACTd,MAAMa,aAAaC,GACnBb,KAAKc,SAASC,iBAAiB,QAASf,KAAKI,0BAEjDY,QAAQH,GACJd,MAAMiB,QAAQH,GACd,MAAMI,EAAajB,KAAKG,UAClBe,EAAatC,EAAgBoB,KAAKL,YAAaK,KAAKE,gBAAiBV,EAAwB2B,kBAAkBC,KAAIb,GAAKA,EAAEZ,cAAcsB,GAC1IA,IAAeC,IACflB,KAAKG,UAAYe,EACjBlB,KAAKqB,cAAc,YAAaJ,IAGxCK,oBACIvB,MAAMuB,oBACNtB,KAAKuB,UAAY,OACjBvB,KAAKwB,KAAO,SACZC,OAAOV,iBAAiB,UAAWf,KAAKM,mBAE5CoB,uBACI3B,MAAM2B,uBACND,OAAOE,oBAAoB,UAAW3B,KAAKM,mBAC3CN,KAAKc,SAASa,oBAAoB,QAAS3B,KAAKI,0BAEpDC,aAAauB,EAAU,UACnB5B,KAAK6B,YAAYC,KAAKF,GAEtBG,uBACA,OAAOC,CAAK,eACLhC,KAAKG,UAAY,2BAA6B,gDAIzD8B,SACI,OAAOD,CAAK,GACZhC,KAAK+B,8GAMEG,oBACP,MAAO,CAACC,EAAYD,KAG5BE,EAAW,CACPC,EAAS,CAAEC,KAAMC,UAClB3C,EAAmB4C,UAAW,iBAAa,GAC9CJ,EAAW,CACPK,KACD7C,EAAmB4C,UAAW,uBAAmB,GACpDJ,EAAW,CACPK,KACD7C,EAAmB4C,UAAW,mBAAe,GAChDJ,EAAW,CACPM,EAAM,CAAEJ,KAAMK,WACf/C,EAAmB4C,UAAW,iBAAa,GAC9CJ,EAAW,CACPQ,EAAM,sBACPhD,EAAmB4C,UAAW,gBAAY,GAC7C5C,EAAqBwC,EAAW,CAC5BS,EAAQ,CACJC,OAAQ,CACJC,KAAMC,EAAiBC,GACvBC,MAAOD,MAGhBrD"}